<analysis>**original_problem_statement:**
The user's goal is to build a comprehensive Proposal Generation Module. The work has focused on enhancing the proposal creation wizards ( and ) with advanced, dynamic modules.

Recent user requests include:
1.  **HTML Rendering Fix:** Correcting an issue where content from new modules was showing as raw HTML in the proposal preview.
2.  **Timeline Module Redesign:** Transforming the Zaman Çizelgesi (Timeline) module from a simple text area into a detailed, interactive, and visually rich component specifically designed for fair stand projects. The user clarified that this should be unique to each proposal, not a reusable profile template.
3.  **A4 Page Splitting:** Ensuring the long, detailed timeline preview is automatically split across multiple A4-sized pages to be readable in the final PDF.
4.  **Payment Terms Module Redesign:** Overhauling the Ödeme Koşulları (Payment Terms) module to be a dynamic payment plan system. This includes features like using predefined payment profiles, dynamically adding/removing payment installments, calculating amounts based on a total price, and selecting bank accounts.
5.  **Pricing and Payment Terms Integration:** Merging the Fiyat (Pricing) step directly into the Ödeme Koşulları module. The user wants to set the price and define the payment plan on the same screen for a streamlined workflow.

**User's preferred language**: Turkish

**what currently exists?**
The application features a multi-step proposal generation system. The core wizards for creating proposal profiles (templates) and new proposals are functional.

-   **Timeline Module:** A sophisticated, interactive  component has been created and integrated into . It is no longer part of the profile template but is created uniquely for each new proposal. The preview of this module is styled to break across A4 pages.
-   **HTML Rendering:** A critical bug causing raw HTML to be displayed in the proposal preview for newly added modules has been fixed by ensuring the correct data property () is used.
-   **Payment Terms Module (In Progress):** A new  and a corresponding  have been created. Backend endpoints for managing payment profiles () have been added.
-   **Critical Bug Fix:** A backend-crashing bug due to a Pydantic v2 update ( to ) was identified and resolved, restoring functionality to the Customers and Opportunities pages.

**Last working item**:
-   Last item agent was working: Fixing a critical React error, Rendered more hooks than during the previous render, in . The error was caused by conditionally calling  and  hooks after moving the pricing form logic into the component. The agent identified the cause and moved the hooks to the top level of the component function.
-   Status: **IN PROGRESS**
-   Agent Testing Done: N
-   Which testing method agent to use? Frontend testing agent to verify the hook rule fix and test the combined functionality of the integrated pricing form and the payment terms module.
-   User Testing Done: N

**All Pending/In progress Issue list**:
-   Issue 1: **(P0)** Critical React Error: Rendered more hooks than during the previous render in .
-   Issue 2: **(P1)** Recurring  property errors in .
-   Issue 3: **(P1)** Missing backend API endpoint for bank accounts.
-   Issue 4: **(P2)** Redundant Pricing step in .
-   Issue 5: **(P2)** Low-priority legacy issues (form validations, UI text).

**Issues Detail:**
-   **Issue 1: Critical React Error: Rendered more hooks than during the previous render (P0)**
    -   **Attempted fixes:** The agent correctly identified that React hooks were being called conditionally, which violates hooks rules. The agent moved the  and  calls for  to the top level of the  component.
    -   **Next debug checklist:**
        1.  Run the frontend testing agent to confirm the hook rule violation is resolved.
        2.  Thoroughly test the  to ensure that moving the hooks did not introduce other side effects.
    -   **Why fix this issue and what will be achieved with the fix?** This is a critical, application-crashing error. Fixing it is necessary to render the  and continue development.
    -   **Status:** IN PROGRESS
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** Frontend.
    -   **Blocked on other issue:** None.

-   **Issue 2: Recurring  property errors in  (P1)**
    -   **Attempted fixes:** The agent repeatedly added optional chaining () to prevent crashes when accessing properties like , , and . This only treats the symptom, not the cause.
    -   **Next debug checklist:**
        1.  Review the  initialization for  in . Ensure the initial state (from  prop or ) always has , , and  initialized as empty arrays (), not  or .
        2.  Modify the  hook that fetches data to set  and  to  in the  block if the API call fails.
    -   **Why fix this issue and what will be achieved with the fix?** To create a robust and error-free component instead of relying on patchy fixes.
    -   **Status:** IN PROGRESS
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** Frontend.
    -   **Blocked on other issue:** Issue 1.

-   **Issue 3: Missing backend API endpoint for bank accounts (P1)**
    -   **Description:** The  component makes a  request to , but this endpoint does not exist, causing the bank selection feature to fail silently.
    -   **Next debug checklist:**
        1.  Create a new router or update an existing one in  to handle .
        2.  This endpoint should query the database for bank accounts (likely from a  or  collection) and return them as a JSON array.
        3.  Restart the backend server after adding the new route.
    -   **Why fix this issue and what will be achieved with the fix?** This will enable the bank selection functionality in the new Payment Terms module.
    -   **Status:** NOT STARTED
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** Backend.
    -   **Blocked on other issue:** None.

-   **Issue 4: Redundant Pricing step in  (P2)**
    -   **Description:** Since the user requested the pricing form be moved inside the Payment Terms module, the old Fiyat step in the wizard is now redundant and confusing.
    -   **Next debug checklist:**
        1.  In , locate the  array or equivalent logic that defines the wizard flow.
        2.  Remove or conditionally hide the Fiyat (Pricing) step.
    -   **Why fix this issue and what will be achieved with the fix?** This will align the UI with the user's requested workflow and prevent confusion.
    -   **Status:** NOT STARTED
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** Frontend.
    -   **Blocked on other issue:** None.

**In progress Task List**:
-   **Task 1: Finalize Payment Terms & Pricing Integration (P0)**
    -   **Where to resume:** After fixing the critical React Hook error (Issue 1) and undefined property errors (Issue 2) in .
    -   **What will be achieved with this?** A fully functional, combined pricing and payment terms module as requested by the user.
    -   **Status:** IN PROGRESS
    -   **Should Test frontend/backend/both after fix?** Both.
    -   **Blocked on something:** Issue 1, Issue 2, Issue 3.

**Upcoming and Future Tasks**
-   **Upcoming Tasks:**
    -   **(P1)** Create the missing  backend endpoint.
    -   **(P1)** Remove the now-redundant Pricing step from the .
    -   **(P1)** Backend PDF Generation & Emailing: Implement  and .
    -   **(P1)** Proposal Detail Page: Create a page to display a sent proposal's details.
-   **Future Tasks:**
    -   **(P2)** Public Proposal View Page: Create a public-facing page () for customers.
    -   **(P2)** Refactor/Remove Old Code: The old  is redundant and can be removed.
    -   **(P2)** Re-enable form validations in wizards, which were disabled for testing.

**Completed work in this session**
-   **Feature:** Implemented a new, highly detailed, and interactive Timeline module () for fair projects.
-   **Refactor:** Moved the Timeline module logic from the profile wizard (template) to the new proposal wizard (instance-specific) based on user feedback.
-   **Feature:** Implemented a page-breaking layout for the timeline preview to ensure it fits A4 format.
-   **Feature:** Created backend APIs () to manage reusable payment plan templates.
-   **Feature:** Created new frontend components (, ) to build a dynamic payment plan system.
-   **Bug Fix:** Corrected a bug where newly added modules displayed raw HTML in the proposal preview.
-   **Bug Fix:** Resolved a critical backend crash caused by a Pydantic v2  keyword change, which was affecting the Customers and Opportunities pages.
-   **Bug Fix:** Fixed a  crash in .

**Earlier issues found/mentioned but not fixed**
-   Form validations are still disabled in  and .
-   The 3 şablon mevcut text review is pending.
-   A legacy test data button on  is likely broken.

**Known issue recurrence from previous fork**
-   The issue of Undefined array properties (, , ) in  has become a recurring problem within this session. The agent has made multiple attempts to fix it with optional chaining () instead of addressing the root cause in state initialization.

**Code Architecture**


**Key Technical Concepts**
-   **React Hooks Rules:** The current primary blocker is a violation of these rules (calling hooks conditionally).
-   **Component State Initialization:** The recurring undefined errors highlight the importance of correctly initializing state with default values (e.g., empty arrays).
-   **Data-Driven UI:** The new Timeline and Payment Terms modules are complex components driven by structured JSON data.
-   **Parent-Child State Communication:** The integration of the pricing form into the payment terms module requires passing state (total amount) between them.
-   **FastAPI & Pydantic:** Used for creating the new backend endpoints. A Pydantic version change caused a critical bug that was resolved.

**key DB schema**
-   **payment_profiles:** 

**changes in tech stack**
None.

**All files**
-   **/app/backend/routes/payment_profiles.py**: (NEW) Created to provide API endpoints for creating and listing payment plan profiles.
-   **/app/backend/server.py**: (UPDATED) Modified to include the new  router.
-   **/app/frontend/src/components/proposals/TimelineModule.jsx**: (NEW) A large, self-contained component for creating and displaying a project timeline.
-   **/app/frontend/src/components/proposals/PaymentTermsModule.jsx**: (NEW & BROKEN) The new component for managing payment plans. Currently contains a critical React hooks error.
-   **/app/frontend/src/components/proposals/PaymentProfileModal.jsx**: (NEW) A modal for creating new payment plan profiles.
-   **/app/frontend/src/pages/proposals/NewProposalWizard.jsx**: (HEAVILY UPDATED) Integrated the new Timeline and Payment Terms modules, and fixed the HTML rendering bug.
-   **/app/frontend/src/pages/proposals/ProposalProfileWizard.jsx**: (UPDATED) Fixed the template selector bug and removed the timeline module logic.

**Areas that need refactoring**:
-    has become very large by embedding the entire pricing form logic. This pricing section could be extracted into its own component.
-    remains a monolithic component that is difficult to maintain.

**key api endpoints**
-    (Implemented)
-    (Implemented)
-    (**Required but NOT Implemented**)

**Critical Info for New Agent**
-   **IMMEDIATE TASK (P0):** You must fix the critical React error Rendered more hooks than during the previous render in . The previous agent attempted a fix by moving hooks to the top level; you need to verify this and test it. The application will not render this module until this is fixed.
-   **RECURRING BUG (P1):** The  is plagued by errors from  arrays (, , ). Do not just add more . Fix the root cause by ensuring the state is always initialized with empty arrays () in  and in API error-handling logic.
-   **MISSING API (P1):** The frontend requires a  endpoint. You will need to create this in the backend to make the bank selection feature work.
-   **USER WORKFLOW:** The user's latest request is to have the Pricing form *inside* the Payment Terms module, not as a separate step. Your goal is to stabilize the work-in-progress implementation of this combined view.
-   **LANGUAGE:** You **MUST** continue all communication with the user in **Turkish**.

**documents created in this job**
None.

**Last 5 User Messages and any pending user messages**
1.  **User:** Requested a complete redesign of the Zaman Çizelgesi (Timeline) module to be a detailed, interactive timeline for fair projects. **Status: COMPLETED.**
2.  **User:** Clarified that the Timeline should be unique to each proposal, not a reusable template, which required moving it from the profile wizard to the new proposal wizard. **Status: COMPLETED.**
3.  **User:** Reported that the long timeline preview was overflowing the A4 page format. **Status: COMPLETED.**
4.  **User:** Provided a detailed prompt to completely overhaul the Ödeme Koşulları (Payment Terms) module with dynamic profiles, installments, and calculations. **Status: IN PROGRESS.**
5.  **User:** Requested that the Fiyat (Pricing) module be moved from its own step and placed at the top of the Ödeme Koşulları module to streamline the workflow. **Status: IN PROGRESS (and source of current critical bug).**

**Project Health Check:**
-   **Broken:** The  is critically broken due to a React hooks rule violation and several undefined property errors. This makes the Ödeme Koşulları module completely unusable.
-   **Mocked:** The bank selection feature within  is non-functional because it relies on a  API endpoint that does not exist.

**Testing status**
-   **Testing agent used after significant changes:** YES
-   **Troubleshoot agent used after agent stuck in loop:** NO
-   **Test files created:** None.
-   **Known regressions:** The implementation of the new Payment Terms module has introduced multiple application-crashing bugs.

**Credentials to test flow:**
Not applicable.

**What agent forgot to execute**
-   The agent did not create the required  backend endpoint needed by the new .
-   The agent did not remove or disable the old Pricing (Step 4) from the  after starting to integrate it into the Payment Terms module.</analysis>
