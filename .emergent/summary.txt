<analysis>**original_problem_statement:**
The user's primary goal was to perform a major architectural refactor of the frontend, replacing a state-based navigation system with a new, robust Enterprise Multi-Tenant URL Routing architecture. After successfully completing this migration, the user requested the integration of a new Advances (Avanslar) module. Subsequently, the user requested significant feature additions and redesigns for the Invoices (Faturalar) module, including a professional purchase invoice form with KDV (VAT) calculations. The current task is to fix and completely overhaul the Credit Cards (Kredi Kartları) management page, and then implement the full backend and UI fixes for the Purchase Invoices (Alış Faturaları) module.

PRODUCT REQUIREMENTS:
- Integrate the Advances module and its pages (list, new request, settings).
- Enhance the Invoices module with a tabbed UI, a dynamic invoice type dropdown, and a professional purchase invoice form with VAT calculations and a working backend.
- Implement a fully functional Credit Cards management page with specific UI/UX features, validation, and security (encryption, role-based access).
- Implement a list page for Purchase Invoices.
- Ensure all UI elements and functionalities match the user's provided screenshots and detailed instructions.
- Implement corresponding backend logic with real database persistence (MongoDB) for all new features.

**User's preferred language**: Turkish

**what currently exists?**
The application has a stable URL-based, multi-tenant routing system.
- **Credit Cards Module**: A complete, professional credit card management page exists at . It was rewritten from scratch and is fully functional. It includes a tabbed UI (Corporate/Personal), backend encryption (), frontend and backend validation (Luhn algorithm), automatic card-type detection (Visa/Mastercard/Amex), masked number display, and a role-based Preview feature for  users to view the unencrypted card number.
- **Invoices Module**: The New Invoice page () features a tabbed layout. The Purchase Invoice form is highly advanced, with dynamic calculations, a working backend  endpoint that saves invoices to MongoDB, and updates related account balances (suppliers, banks). It also features a success modal after saving. A new list page for all purchase invoices has been created at . Dropdowns for Bank and Credit Card selection are now correctly populated.

**Last working item**:
-   Last item agent was working: The user requested a UI layout change for the Purchase Invoices form (). The agent was in the process of moving the summary statistics boxes (Net Total, VAT Total, etc.) from the bottom of the page to the top, directly underneath the header.
-   Status: **IN PROGRESS**
-   Agent Testing Done: N
-   Which testing method agent to use? **screenshot tool** to verify the new layout of the Alış Faturaları tab.
-   User Testing Done: N

**All Pending/In progress Issue list**:
-   **Issue 1: Move Purchase Invoice Statistics Boxes to the Top (P0)**

**Issues Detail:**
-   **Issue 1:**
    -   **Attempted fixes:** The agent has not yet attempted the fix. The last action was to locate the code for the Alış Faturaları section to begin the refactor.
    -   **Next debug checklist:**
        1.  Open .
        2.  Locate the JSX for the statistics boxes (currently at the bottom of the  block).
        3.  Cut this JSX block.
        4.  Paste it directly below the header section but before the  section, as per the user's detailed instructions in the last message.
        5.  Ensure the old container for the statistics boxes at the bottom is removed to avoid duplication.
        6.  Test using the screenshot tool to confirm the new layout.
    -   **Why fix this issue and what will be achieved with the fix?** This is a direct UI/UX request from the user to improve the layout and visibility of key totals on the form.
    -   **Status:** NOT STARTED
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** frontend
    -   **Blocked on other issue:** None

**In progress Task List**:
-   There are no other in-progress tasks.

**Upcoming and Future Tasks**
-   **(P1) Finalize Advances Module Backend:** A full review is needed to ensure all CRUD operations for the module are fully implemented and validated.
-   **(P2) Implement Full Advances Module Sidebar Navigation:** Ensure all sub-menu items for the Avanslar section navigate correctly.
-   **(P3) Decommission Old System Code:** Audit and clean up unused components from the old state-based system (e.g., ).
-   **(P4) Implement Backend Tenant Fetching:** In , replace mock tenant data with a real API call.
-   **(P5) Add Missing Modules:** Add the Sales Reports and Reports modules.
-   **(P6) Implement Query Parameters:** Add support for URL query parameters for filtering, sorting, and pagination across all list pages.

**Completed work in this session**
-   **Credit Cards Module - Complete Overhaul:**
    -   Rewrote the entire credit card management page from scratch ().
    -   Implemented a secure backend with  for encryption/decryption.
    -   Added backend and frontend validation using the Luhn algorithm and expiry date checks.
    -   Implemented a role-based Preview button for  to view unencrypted card numbers via a secure endpoint ().
    -   Removed the Spending Limit field as per updated user requirements.
    -   The feature is fully tested (manually by agent, verified by user) and complete.

-   **Purchase Invoices Module - Major Enhancements:**
    -   Created a new backend router () and API endpoints (, , ).
    -   Implemented complex backend logic to update supplier, bank, and cash account balances upon invoice payment.
    -   Activated the Save button on the frontend () to persist data.
    -   Created a new list page () at  to display all saved invoices.
    -   Fixed multiple UI bugs:
        -   Corrected currency display in total boxes to show both foreign currency and TL equivalent.
        -   Fixed Bank and Credit Card dropdowns to display correct data from the API.
        -   Added a success modal that appears after saving an invoice, replacing the generic .
        -   Ensured the saved invoice row turns green and the Save button is disabled.

**Earlier issues found/mentioned but not fixed**
-   None. The previously mentioned issue of unsaved purchase invoices has been resolved in this session.

**Known issue recurrence from previous fork**
-   The Credit Cards management page was a recurring issue, but it has now been completely rewritten and is considered stable and resolved.

**Code Architecture**


**Key Technical Concepts**
-   **Backend Security:** Implemented symmetric encryption for sensitive data (credit card numbers) using Python's  (Fernet) library.
-   **Role-Based Access Control (RBAC):** Created a special feature (viewing unencrypted data) accessible only to users with an  or  role, enforced on the backend by checking a request header.
-   **Data Validation:** Utilized the Luhn algorithm on both frontend and backend to validate credit card number integrity.
-   **Complex State Management in React:** Managed a dynamic list of invoice items, each with its own state, calculations, and UI feedback ( status).
-   **User-Driven Development:** The entire session was guided by highly specific, code-level instructions from the user, demonstrating a tight feedback loop.

**key DB schema**
-   ****: 
-   ****: 
-   ****: Now includes a  field updated by purchase invoices.
-   ****: Now includes a  field updated by purchase invoices.

**changes in tech stack**
-   None.

**All files of reference**
-   **/app/frontend/src/components/Accounting/NewInvoiceForm.jsx**: **Primary file for the current task.** Contains the layout for the purchase invoice form that needs to be changed.
-   **/app/frontend/src/components/Settings/CreditCardsManagementV2.jsx**: The completed, stable credit card component.
-   **/app/backend/routes/credit_cards.py**: The backend logic for credit cards, including encryption and the  endpoint.
-   **/app/backend/routes/purchase_invoices.py**: The backend logic for saving purchase invoices and updating account balances.
-   **/app/frontend/src/pages/invoices/PurchaseInvoiceListPage.jsx**: The newly created page for listing purchase invoices.
-   **/app/frontend/src/App.js**: Contains the routing for the new purchase invoice list page.

**Areas that need refactoring**:
-   The original  is now obsolete and should be deleted.

**key api endpoints**
-   : Creates a new credit card (with encryption).
-   : Lists all saved credit cards (with masked numbers).
-   : Deletes a credit card.
-   : **(Role-protected)** Returns the unencrypted details of a single card.
-   : Saves a single purchase invoice item and updates relevant balances.
-   : Saves multiple purchase invoice items.
-   : Lists all saved purchase invoices.

**Critical Info for New Agent**
-   **Follow User Instructions Precisely:** The user provides extremely detailed, code-level instructions and acts as the lead architect and tester. Your primary job is to implement their requests accurately. Do not deviate from the provided code snippets unless absolutely necessary.
-   **Current Task is UI Only:** The immediate task is a simple JSX layout change in . No backend work is needed.
-   **The user is the tester:** The user will test the features after you complete them. Your testing should focus on verifying the implementation before handing it over. Use the screenshot tool for UI changes and  for backend changes.

**documents created in this job**
-   None.

**Last 10 User Messages and any pending user messages**
-   **User:** Requested a success modal for saving purchase invoices. (COMPLETED)
-   **User:** Pointed out that Bank and Credit Card dropdowns were showing incorrect data. (COMPLETED)
-   **User:** Provided a screenshot showing the broken dropdowns. (ADDRESSED)
-   **User:** Confirmed the dropdowns were fixed but a temporary debug panel was visible. (COMPLETED)
-   **User:** Requested the debug panel be removed. (COMPLETED)
-   **User:** Confirmed the debug panel was gone. (ADDRESSED)
-   **User:** (PENDING) Pointed out that the statistics boxes on the purchase invoice form are at the bottom and should be moved to the top, under the header. Provided detailed instructions on how to restructure the JSX.

**Project Health Check:**
-   **Broken:** None.
-   **Mocked:** None. The project is in a very healthy state. The major problematic features have been fixed and are now fully functional.

**3rd Party Integrations**:
-   None.

**Testing status**
-   Testing agent used after significant changes: NO
-   Troubleshoot agent used after agent stuck in loop: NO
-   Test files created: []
-   Known regressions: None.

**Credentials to test flow:**
-   To test the admin-only Preview feature for credit cards, assume the logged-in user has the role of  as seen in .

**What agent forgot to execute**
-   The agent was in the middle of executing the user's last request (moving the stats boxes) when the session ended. It has not been forgotten, but is the immediate next step.</analysis>
